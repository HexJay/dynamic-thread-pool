<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€çº¿ç¨‹æ± ç›‘æ§å¹³å°</title>
    <!-- ä½¿ç”¨å›½å†…CDNåŠ é€Ÿè®¿é—® -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@latest/dist/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue@latest/dist/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #app {
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .header-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header-subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .thread-pool-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .thread-pool-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .thread-pool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .thread-pool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pool-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .pool-app {
            font-size: 12px;
            color: #999;
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .pool-metrics {
            margin-top: 20px;
        }

        .metric-item {
            margin-bottom: 15px;
        }

        .metric-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: #666;
        }

        .metric-value {
            font-weight: 600;
            color: #333;
        }

        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-title">ğŸš€ åŠ¨æ€çº¿ç¨‹æ± ç›‘æ§å¹³å°</div>
            <div class="header-subtitle">å®æ—¶ç›‘æ§å’Œç®¡ç†æ‚¨çš„çº¿ç¨‹æ± çŠ¶æ€</div>
        </div>

        <div class="auto-refresh">
            <el-switch v-model="autoRefresh" @change="handleAutoRefreshChange"></el-switch>
            <span>è‡ªåŠ¨åˆ·æ–°ï¼ˆ5ç§’ï¼‰</span>
            <el-button type="primary" :icon="Refresh" @click="loadData" :loading="loading">æ‰‹åŠ¨åˆ·æ–°</el-button>
            <el-input 
                v-model="searchText" 
                placeholder="æœç´¢åº”ç”¨åæˆ–çº¿ç¨‹æ± å..." 
                style="width: 300px; margin-left: 20px;"
                clearable
                :prefix-icon="Search">
            </el-input>
            <el-select v-model="filterStatus" placeholder="ç­›é€‰çŠ¶æ€" style="width: 150px; margin-left: 10px;" clearable>
                <el-option label="å…¨éƒ¨" value=""></el-option>
                <el-option label="æ­£å¸¸" value="normal"></el-option>
                <el-option label="ä¸­è´Ÿè½½" value="medium"></el-option>
                <el-option label="é«˜è´Ÿè½½" value="high"></el-option>
            </el-select>
            <span style="margin-left: auto; color: #999; font-size: 12px;">
                æœ€åæ›´æ–°: {{ lastUpdateTime }}
            </span>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">åº”ç”¨æ€»æ•°</div>
                <div class="stat-value">{{ statistics.totalApps }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">çº¿ç¨‹æ± æ€»æ•°</div>
                <div class="stat-value">{{ statistics.totalPools }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ´»è·ƒçº¿ç¨‹æ€»æ•°</div>
                <div class="stat-value">{{ statistics.totalActiveThreads }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">é˜Ÿåˆ—ä»»åŠ¡æ€»æ•°</div>
                <div class="stat-value">{{ statistics.totalQueueSize }}</div>
            </div>
        </div>

        <div v-loading="loading" class="thread-pool-container" v-if="filteredThreadPools.length > 0">
            <div class="thread-pool-card" v-for="pool in filteredThreadPools" :key="pool.appName + pool.threadPoolName">
                <div class="pool-header">
                    <div>
                        <div class="pool-name">{{ pool.threadPoolName }}</div>
                        <div class="pool-app">{{ pool.appName }}</div>
                    </div>
                    <el-tag :type="getStatusType(pool)">{{ getStatus(pool) }}</el-tag>
                </div>

                <div class="pool-metrics">
                    <div class="metric-item">
                        <div class="metric-label">
                            <span>çº¿ç¨‹ä½¿ç”¨ç‡</span>
                            <span class="metric-value">{{ getThreadUsage(pool) }}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" :style="{ width: getThreadUsage(pool) + '%' }"></div>
                        </div>
                    </div>

                    <div class="metric-item">
                        <div class="metric-label">
                            <span>é˜Ÿåˆ—ä½¿ç”¨ç‡</span>
                            <span class="metric-value">{{ getQueueUsage(pool) }}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" :style="{ width: getQueueUsage(pool) + '%' }"></div>
                        </div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">æ´»è·ƒçº¿ç¨‹</div>
                        <div class="info-value">{{ pool.activeCount }} / {{ pool.maximumPoolSize }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å½“å‰çº¿ç¨‹</div>
                        <div class="info-value">{{ pool.poolSize }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é˜Ÿåˆ—ç±»å‹</div>
                        <div class="info-value">{{ pool.queueType }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é˜Ÿåˆ—ä»»åŠ¡</div>
                        <div class="info-value">{{ pool.queueSize }}</div>
                    </div>
                </div>

                <div class="actions">
                    <el-button type="primary" size="small" @click="showEditDialog(pool)">è°ƒæ•´é…ç½®</el-button>
                    <el-button type="info" size="small" @click="showDetail(pool)">è¯¦ç»†ä¿¡æ¯</el-button>
                </div>
            </div>
        </div>

        <div v-else-if="!loading && threadPools.length === 0" class="empty-state">
            <div class="empty-icon">ğŸ“Š</div>
            <h3>æš‚æ— çº¿ç¨‹æ± æ•°æ®</h3>
            <p style="color: #999; margin-top: 10px;">è¯·ç¡®ä¿åº”ç”¨ç¨‹åºå·²å¯åŠ¨å¹¶æ­£ç¡®é…ç½®</p>
        </div>

        <div v-else-if="!loading && filteredThreadPools.length === 0 && threadPools.length > 0" class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„çº¿ç¨‹æ± </h3>
            <p style="color: #999; margin-top: 10px;">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ç­›é€‰å™¨</p>
        </div>

        <!-- ç¼–è¾‘å¯¹è¯æ¡† -->
        <el-dialog v-model="editDialogVisible" title="è°ƒæ•´çº¿ç¨‹æ± é…ç½®" width="500px">
            <el-form :model="editForm" label-width="120px">
                <el-form-item label="åº”ç”¨åç§°">
                    <el-input v-model="editForm.appName" disabled></el-input>
                </el-form-item>
                <el-form-item label="çº¿ç¨‹æ± åç§°">
                    <el-input v-model="editForm.threadPoolName" disabled></el-input>
                </el-form-item>
                <el-form-item label="æ ¸å¿ƒçº¿ç¨‹æ•°">
                    <el-input-number v-model="editForm.corePoolSize" :min="1" :max="1000"></el-input-number>
                </el-form-item>
                <el-form-item label="æœ€å¤§çº¿ç¨‹æ•°">
                    <el-input-number v-model="editForm.maximumPoolSize" :min="1" :max="1000"></el-input-number>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="editDialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="updateConfig" :loading="updating">ç¡®å®š</el-button>
            </template>
        </el-dialog>

        <!-- è¯¦æƒ…å¯¹è¯æ¡† -->
        <el-dialog v-model="detailDialogVisible" title="çº¿ç¨‹æ± è¯¦ç»†ä¿¡æ¯" width="600px">
            <el-descriptions :column="2" border v-if="currentPool">
                <el-descriptions-item label="åº”ç”¨åç§°">{{ currentPool.appName }}</el-descriptions-item>
                <el-descriptions-item label="çº¿ç¨‹æ± åç§°">{{ currentPool.threadPoolName }}</el-descriptions-item>
                <el-descriptions-item label="æ ¸å¿ƒçº¿ç¨‹æ•°">{{ currentPool.corePoolSize }}</el-descriptions-item>
                <el-descriptions-item label="æœ€å¤§çº¿ç¨‹æ•°">{{ currentPool.maximumPoolSize }}</el-descriptions-item>
                <el-descriptions-item label="å½“å‰æ´»è·ƒçº¿ç¨‹">{{ currentPool.activeCount }}</el-descriptions-item>
                <el-descriptions-item label="å½“å‰æ± ä¸­çº¿ç¨‹">{{ currentPool.poolSize }}</el-descriptions-item>
                <el-descriptions-item label="é˜Ÿåˆ—ç±»å‹">{{ currentPool.queueType }}</el-descriptions-item>
                <el-descriptions-item label="å½“å‰é˜Ÿåˆ—ä»»åŠ¡">{{ currentPool.queueSize }}</el-descriptions-item>
                <el-descriptions-item label="é˜Ÿåˆ—å‰©ä½™å®¹é‡">{{ currentPool.remainingCapacity }}</el-descriptions-item>
                <el-descriptions-item label="çº¿ç¨‹ä½¿ç”¨ç‡">{{ getThreadUsage(currentPool) }}%</el-descriptions-item>
                <el-descriptions-item label="é˜Ÿåˆ—ä½¿ç”¨ç‡">{{ getQueueUsage(currentPool) }}%</el-descriptions-item>
            </el-descriptions>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = ref(false);
                const updating = ref(false);
                const threadPools = ref([]);
                const autoRefresh = ref(true);
                const refreshInterval = ref(null);
                const lastUpdateTime = ref('');
                const editDialogVisible = ref(false);
                const detailDialogVisible = ref(false);
                const currentPool = ref(null);
                const searchText = ref('');
                const filterStatus = ref('');
                const editForm = ref({
                    appName: '',
                    threadPoolName: '',
                    corePoolSize: 0,
                    maximumPoolSize: 0
                });

                // API åŸºç¡€è·¯å¾„
                const API_BASE = '/api/dynamic_thread_pool';

                // ç»Ÿè®¡ä¿¡æ¯
                const statistics = computed(() => {
                    const apps = new Set(threadPools.value.map(p => p.appName));
                    return {
                        totalApps: apps.size,
                        totalPools: threadPools.value.length,
                        totalActiveThreads: threadPools.value.reduce((sum, p) => sum + p.activeCount, 0),
                        totalQueueSize: threadPools.value.reduce((sum, p) => sum + p.queueSize, 0)
                    };
                });

                // è·å–çŠ¶æ€ç±»å‹ï¼ˆç”¨äºç­›é€‰ï¼‰
                const getPoolStatusType = (pool) => {
                    const usage = Math.round((pool.activeCount / pool.maximumPoolSize) * 100);
                    if (usage >= 80) return 'high';
                    if (usage >= 50) return 'medium';
                    return 'normal';
                };

                // è¿‡æ»¤åçš„çº¿ç¨‹æ± åˆ—è¡¨
                const filteredThreadPools = computed(() => {
                    let result = threadPools.value;

                    // æœç´¢è¿‡æ»¤
                    if (searchText.value) {
                        const search = searchText.value.toLowerCase();
                        result = result.filter(pool => 
                            pool.appName.toLowerCase().includes(search) || 
                            pool.threadPoolName.toLowerCase().includes(search)
                        );
                    }

                    // çŠ¶æ€è¿‡æ»¤
                    if (filterStatus.value) {
                        result = result.filter(pool => getPoolStatusType(pool) === filterStatus.value);
                    }

                    return result;
                });

                // åŠ è½½æ•°æ®
                const loadData = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get(`${API_BASE}/query_thread_pool_list`);
                        const body = response.data || {};
                        if (body.status === 0) {
                            // åç«¯é€šè¿‡ @JsonAnyGetter å°† data æ‰å¹³åˆ°é¡¶å±‚
                            const configs = body.configs || (body.data && body.data.configs) || [];
                            threadPools.value = Array.isArray(configs) ? configs : [];
                            lastUpdateTime.value = new Date().toLocaleTimeString();
                        } else {
                            ElMessage.error(body.msg || 'åŠ è½½æ•°æ®å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        loading.value = false;
                    }
                };

                // è·å–çº¿ç¨‹ä½¿ç”¨ç‡
                const getThreadUsage = (pool) => {
                    if (pool.maximumPoolSize === 0) return 0;
                    return Math.round((pool.activeCount / pool.maximumPoolSize) * 100);
                };

                // è·å–é˜Ÿåˆ—ä½¿ç”¨ç‡
                const getQueueUsage = (pool) => {
                    const total = pool.queueSize + pool.remainingCapacity;
                    if (total === 0) return 0;
                    return Math.round((pool.queueSize / total) * 100);
                };

                // è·å–çŠ¶æ€
                const getStatus = (pool) => {
                    const usage = getThreadUsage(pool);
                    if (usage >= 80) return 'é«˜è´Ÿè½½';
                    if (usage >= 50) return 'ä¸­è´Ÿè½½';
                    return 'æ­£å¸¸';
                };

                // è·å–çŠ¶æ€ç±»å‹
                const getStatusType = (pool) => {
                    const usage = getThreadUsage(pool);
                    if (usage >= 80) return 'danger';
                    if (usage >= 50) return 'warning';
                    return 'success';
                };

                // æ˜¾ç¤ºç¼–è¾‘å¯¹è¯æ¡†
                const showEditDialog = (pool) => {
                    editForm.value = {
                        appName: pool.appName,
                        threadPoolName: pool.threadPoolName,
                        corePoolSize: pool.corePoolSize,
                        maximumPoolSize: pool.maximumPoolSize,
                        queueType: pool.queueType
                    };
                    editDialogVisible.value = true;
                };

                // æ˜¾ç¤ºè¯¦æƒ…
                const showDetail = (pool) => {
                    currentPool.value = pool;
                    detailDialogVisible.value = true;
                };

                // æ›´æ–°é…ç½®
                const updateConfig = async () => {
                    if (editForm.value.corePoolSize > editForm.value.maximumPoolSize) {
                        ElMessage.warning('æ ¸å¿ƒçº¿ç¨‹æ•°ä¸èƒ½å¤§äºæœ€å¤§çº¿ç¨‹æ•°');
                        return;
                    }

                    updating.value = true;
                    try {
                        const response = await axios.post(`${API_BASE}/update_thread_pool_config`, editForm.value);
                        if ((response.data || {}).status === 0) {
                            ElMessage.success('é…ç½®æ›´æ–°æˆåŠŸ');
                            editDialogVisible.value = false;
                            setTimeout(() => loadData(), 1000); // å»¶è¿Ÿåˆ·æ–°ä»¥ç­‰å¾…é…ç½®ç”Ÿæ•ˆ
                        } else {
                            ElMessage.error((response.data || {}).msg || 'é…ç½®æ›´æ–°å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
                        ElMessage.error('æ›´æ–°é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        updating.value = false;
                    }
                };

                // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
                const handleAutoRefreshChange = (value) => {
                    if (value) {
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                };

                const startAutoRefresh = () => {
                    stopAutoRefresh();
                    refreshInterval.value = setInterval(() => {
                        loadData();
                    }, 5000);
                };

                const stopAutoRefresh = () => {
                    if (refreshInterval.value) {
                        clearInterval(refreshInterval.value);
                        refreshInterval.value = null;
                    }
                };

                // ç”Ÿå‘½å‘¨æœŸ
                onMounted(() => {
                    loadData();
                    if (autoRefresh.value) {
                        startAutoRefresh();
                    }
                });

                onUnmounted(() => {
                    stopAutoRefresh();
                });

                return {
                    loading,
                    updating,
                    threadPools,
                    autoRefresh,
                    lastUpdateTime,
                    statistics,
                    filteredThreadPools,
                    searchText,
                    filterStatus,
                    editDialogVisible,
                    detailDialogVisible,
                    currentPool,
                    editForm,
                    loadData,
                    getThreadUsage,
                    getQueueUsage,
                    getStatus,
                    getStatusType,
                    showEditDialog,
                    showDetail,
                    updateConfig,
                    handleAutoRefreshChange,
                    // ä½¿ç”¨ IIFE ç‰ˆæœ¬çš„ Element Plus å›¾æ ‡åº“
                    Refresh: ElementPlusIconsVue.Refresh,
                    Search: ElementPlusIconsVue.Search
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>

