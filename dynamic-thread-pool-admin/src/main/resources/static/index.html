<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动态线程池监控平台</title>
    <!-- 使用国内CDN加速访问 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@latest/dist/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue@latest/dist/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #app {
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .header-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header-subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .thread-pool-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .thread-pool-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .thread-pool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .thread-pool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pool-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .pool-app {
            font-size: 12px;
            color: #999;
            background: #f5f5f5;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .pool-metrics {
            margin-top: 20px;
        }

        .metric-item {
            margin-bottom: 15px;
        }

        .metric-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            color: #666;
        }

        .metric-value {
            font-weight: 600;
            color: #333;
        }

        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-title">🚀 动态线程池监控平台</div>
            <div class="header-subtitle">实时监控和管理您的线程池状态</div>
        </div>

        <div class="auto-refresh">
            <el-switch v-model="autoRefresh" @change="handleAutoRefreshChange"></el-switch>
            <span>自动刷新（5秒）</span>
            <el-button type="primary" :icon="Refresh" @click="loadData" :loading="loading">手动刷新</el-button>
            <el-input 
                v-model="searchText" 
                placeholder="搜索应用名或线程池名..." 
                style="width: 300px; margin-left: 20px;"
                clearable
                :prefix-icon="Search">
            </el-input>
            <el-select v-model="filterStatus" placeholder="筛选状态" style="width: 150px; margin-left: 10px;" clearable>
                <el-option label="全部" value=""></el-option>
                <el-option label="正常" value="normal"></el-option>
                <el-option label="中负载" value="medium"></el-option>
                <el-option label="高负载" value="high"></el-option>
            </el-select>
            <span style="margin-left: auto; color: #999; font-size: 12px;">
                最后更新: {{ lastUpdateTime }}
            </span>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">应用总数</div>
                <div class="stat-value">{{ statistics.totalApps }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">线程池总数</div>
                <div class="stat-value">{{ statistics.totalPools }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">活跃线程总数</div>
                <div class="stat-value">{{ statistics.totalActiveThreads }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">队列任务总数</div>
                <div class="stat-value">{{ statistics.totalQueueSize }}</div>
            </div>
        </div>

        <div v-loading="loading" class="thread-pool-container" v-if="filteredThreadPools.length > 0">
            <div class="thread-pool-card" v-for="pool in filteredThreadPools" :key="pool.appName + pool.threadPoolName">
                <div class="pool-header">
                    <div>
                        <div class="pool-name">{{ pool.threadPoolName }}</div>
                        <div class="pool-app">{{ pool.appName }}</div>
                    </div>
                    <el-tag :type="getStatusType(pool)">{{ getStatus(pool) }}</el-tag>
                </div>

                <div class="pool-metrics">
                    <div class="metric-item">
                        <div class="metric-label">
                            <span>线程使用率</span>
                            <span class="metric-value">{{ getThreadUsage(pool) }}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" :style="{ width: getThreadUsage(pool) + '%' }"></div>
                        </div>
                    </div>

                    <div class="metric-item">
                        <div class="metric-label">
                            <span>队列使用率</span>
                            <span class="metric-value">{{ getQueueUsage(pool) }}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" :style="{ width: getQueueUsage(pool) + '%' }"></div>
                        </div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">活跃线程</div>
                        <div class="info-value">{{ pool.activeCount }} / {{ pool.maximumPoolSize }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">当前线程</div>
                        <div class="info-value">{{ pool.poolSize }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">队列类型</div>
                        <div class="info-value">{{ pool.queueType }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">队列任务</div>
                        <div class="info-value">{{ pool.queueSize }}</div>
                    </div>
                </div>

                <div class="actions">
                    <el-button type="primary" size="small" @click="showEditDialog(pool)">调整配置</el-button>
                    <el-button type="info" size="small" @click="showDetail(pool)">详细信息</el-button>
                </div>
            </div>
        </div>

        <div v-else-if="!loading && threadPools.length === 0" class="empty-state">
            <div class="empty-icon">📊</div>
            <h3>暂无线程池数据</h3>
            <p style="color: #999; margin-top: 10px;">请确保应用程序已启动并正确配置</p>
        </div>

        <div v-else-if="!loading && filteredThreadPools.length === 0 && threadPools.length > 0" class="empty-state">
            <div class="empty-icon">🔍</div>
            <h3>没有找到匹配的线程池</h3>
            <p style="color: #999; margin-top: 10px;">请尝试调整搜索条件或筛选器</p>
        </div>

        <!-- 编辑对话框 -->
        <el-dialog v-model="editDialogVisible" title="调整线程池配置" width="500px">
            <el-form :model="editForm" label-width="120px">
                <el-form-item label="应用名称">
                    <el-input v-model="editForm.appName" disabled></el-input>
                </el-form-item>
                <el-form-item label="线程池名称">
                    <el-input v-model="editForm.threadPoolName" disabled></el-input>
                </el-form-item>
                <el-form-item label="核心线程数">
                    <el-input-number v-model="editForm.corePoolSize" :min="1" :max="1000"></el-input-number>
                </el-form-item>
                <el-form-item label="最大线程数">
                    <el-input-number v-model="editForm.maximumPoolSize" :min="1" :max="1000"></el-input-number>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="editDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="updateConfig" :loading="updating">确定</el-button>
            </template>
        </el-dialog>

        <!-- 详情对话框 -->
        <el-dialog v-model="detailDialogVisible" title="线程池详细信息" width="600px">
            <el-descriptions :column="2" border v-if="currentPool">
                <el-descriptions-item label="应用名称">{{ currentPool.appName }}</el-descriptions-item>
                <el-descriptions-item label="线程池名称">{{ currentPool.threadPoolName }}</el-descriptions-item>
                <el-descriptions-item label="核心线程数">{{ currentPool.corePoolSize }}</el-descriptions-item>
                <el-descriptions-item label="最大线程数">{{ currentPool.maximumPoolSize }}</el-descriptions-item>
                <el-descriptions-item label="当前活跃线程">{{ currentPool.activeCount }}</el-descriptions-item>
                <el-descriptions-item label="当前池中线程">{{ currentPool.poolSize }}</el-descriptions-item>
                <el-descriptions-item label="队列类型">{{ currentPool.queueType }}</el-descriptions-item>
                <el-descriptions-item label="当前队列任务">{{ currentPool.queueSize }}</el-descriptions-item>
                <el-descriptions-item label="队列剩余容量">{{ currentPool.remainingCapacity }}</el-descriptions-item>
                <el-descriptions-item label="线程使用率">{{ getThreadUsage(currentPool) }}%</el-descriptions-item>
                <el-descriptions-item label="队列使用率">{{ getQueueUsage(currentPool) }}%</el-descriptions-item>
            </el-descriptions>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            setup() {
                const loading = ref(false);
                const updating = ref(false);
                const threadPools = ref([]);
                const autoRefresh = ref(true);
                const refreshInterval = ref(null);
                const lastUpdateTime = ref('');
                const editDialogVisible = ref(false);
                const detailDialogVisible = ref(false);
                const currentPool = ref(null);
                const searchText = ref('');
                const filterStatus = ref('');
                const editForm = ref({
                    appName: '',
                    threadPoolName: '',
                    corePoolSize: 0,
                    maximumPoolSize: 0
                });

                // API 基础路径
                const API_BASE = '/api/dynamic_thread_pool';

                // 统计信息
                const statistics = computed(() => {
                    const apps = new Set(threadPools.value.map(p => p.appName));
                    return {
                        totalApps: apps.size,
                        totalPools: threadPools.value.length,
                        totalActiveThreads: threadPools.value.reduce((sum, p) => sum + p.activeCount, 0),
                        totalQueueSize: threadPools.value.reduce((sum, p) => sum + p.queueSize, 0)
                    };
                });

                // 获取状态类型（用于筛选）
                const getPoolStatusType = (pool) => {
                    const usage = Math.round((pool.activeCount / pool.maximumPoolSize) * 100);
                    if (usage >= 80) return 'high';
                    if (usage >= 50) return 'medium';
                    return 'normal';
                };

                // 过滤后的线程池列表
                const filteredThreadPools = computed(() => {
                    let result = threadPools.value;

                    // 搜索过滤
                    if (searchText.value) {
                        const search = searchText.value.toLowerCase();
                        result = result.filter(pool => 
                            pool.appName.toLowerCase().includes(search) || 
                            pool.threadPoolName.toLowerCase().includes(search)
                        );
                    }

                    // 状态过滤
                    if (filterStatus.value) {
                        result = result.filter(pool => getPoolStatusType(pool) === filterStatus.value);
                    }

                    return result;
                });

                // 加载数据
                const loadData = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get(`${API_BASE}/query_thread_pool_list`);
                        const body = response.data || {};
                        if (body.status === 0) {
                            // 后端通过 @JsonAnyGetter 将 data 扁平到顶层
                            const configs = body.configs || (body.data && body.data.configs) || [];
                            threadPools.value = Array.isArray(configs) ? configs : [];
                            lastUpdateTime.value = new Date().toLocaleTimeString();
                        } else {
                            ElMessage.error(body.msg || '加载数据失败');
                        }
                    } catch (error) {
                        console.error('加载数据失败:', error);
                        ElMessage.error('加载数据失败，请检查网络连接');
                    } finally {
                        loading.value = false;
                    }
                };

                // 获取线程使用率
                const getThreadUsage = (pool) => {
                    if (pool.maximumPoolSize === 0) return 0;
                    return Math.round((pool.activeCount / pool.maximumPoolSize) * 100);
                };

                // 获取队列使用率
                const getQueueUsage = (pool) => {
                    const total = pool.queueSize + pool.remainingCapacity;
                    if (total === 0) return 0;
                    return Math.round((pool.queueSize / total) * 100);
                };

                // 获取状态
                const getStatus = (pool) => {
                    const usage = getThreadUsage(pool);
                    if (usage >= 80) return '高负载';
                    if (usage >= 50) return '中负载';
                    return '正常';
                };

                // 获取状态类型
                const getStatusType = (pool) => {
                    const usage = getThreadUsage(pool);
                    if (usage >= 80) return 'danger';
                    if (usage >= 50) return 'warning';
                    return 'success';
                };

                // 显示编辑对话框
                const showEditDialog = (pool) => {
                    editForm.value = {
                        appName: pool.appName,
                        threadPoolName: pool.threadPoolName,
                        corePoolSize: pool.corePoolSize,
                        maximumPoolSize: pool.maximumPoolSize,
                        queueType: pool.queueType
                    };
                    editDialogVisible.value = true;
                };

                // 显示详情
                const showDetail = (pool) => {
                    currentPool.value = pool;
                    detailDialogVisible.value = true;
                };

                // 更新配置
                const updateConfig = async () => {
                    if (editForm.value.corePoolSize > editForm.value.maximumPoolSize) {
                        ElMessage.warning('核心线程数不能大于最大线程数');
                        return;
                    }

                    updating.value = true;
                    try {
                        const response = await axios.post(`${API_BASE}/update_thread_pool_config`, editForm.value);
                        if ((response.data || {}).status === 0) {
                            ElMessage.success('配置更新成功');
                            editDialogVisible.value = false;
                            setTimeout(() => loadData(), 1000); // 延迟刷新以等待配置生效
                        } else {
                            ElMessage.error((response.data || {}).msg || '配置更新失败');
                        }
                    } catch (error) {
                        console.error('更新配置失败:', error);
                        ElMessage.error('更新配置失败，请检查网络连接');
                    } finally {
                        updating.value = false;
                    }
                };

                // 自动刷新控制
                const handleAutoRefreshChange = (value) => {
                    if (value) {
                        startAutoRefresh();
                    } else {
                        stopAutoRefresh();
                    }
                };

                const startAutoRefresh = () => {
                    stopAutoRefresh();
                    refreshInterval.value = setInterval(() => {
                        loadData();
                    }, 5000);
                };

                const stopAutoRefresh = () => {
                    if (refreshInterval.value) {
                        clearInterval(refreshInterval.value);
                        refreshInterval.value = null;
                    }
                };

                // 生命周期
                onMounted(() => {
                    loadData();
                    if (autoRefresh.value) {
                        startAutoRefresh();
                    }
                });

                onUnmounted(() => {
                    stopAutoRefresh();
                });

                return {
                    loading,
                    updating,
                    threadPools,
                    autoRefresh,
                    lastUpdateTime,
                    statistics,
                    filteredThreadPools,
                    searchText,
                    filterStatus,
                    editDialogVisible,
                    detailDialogVisible,
                    currentPool,
                    editForm,
                    loadData,
                    getThreadUsage,
                    getQueueUsage,
                    getStatus,
                    getStatusType,
                    showEditDialog,
                    showDetail,
                    updateConfig,
                    handleAutoRefreshChange,
                    // 使用 IIFE 版本的 Element Plus 图标库
                    Refresh: ElementPlusIconsVue.Refresh,
                    Search: ElementPlusIconsVue.Search
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>

